version: 1.0.{build}

image: Visual Studio 2017

configuration:
  - Release

platform:
  - x64

environment:
  access_token:
    secure: qBY+/0pT+5RoiwsHkr09q1jT2e0VCpDLAxleRTh+1iHCQXA1N9Z4ETvj+Eo7k2RS

before_build:
  - ps: $env:TAG_MESSAGE = "Automatically generated tag at " + (Get-Date -UFormat "%Y-%m-%d %H:%M:%S")
  - ps: $env:COMMIT_ID = $env:APPVEYOR_REPO_COMMIT.substring(0, 7)
  - ps: $env:TAG_NAME = $env:APPVEYOR_REPO_BRANCH + "-" + $env:COMMIT_ID
  - ps: $env:HAS_TAG = (git tag -l "$env:TAG_NAME")
  - ps: $env:NEED_TO_PUBLISH = $env:APPVEYOR_REPO_COMMIT_MESSAGE.Contains("[deploy]") -and ($env:APPVEYOR_REPO_TAG -eq "false") -and !$env:HAS_TAG
  - ps: $env:BRANCH_NAME = (git rev-parse --abbrev-ref HEAD)

  - ps: |
      if ($env:NEED_TO_PUBLISH) {
        Add-Content "$HOME\.git-credentials" "https://$($env:access_token):x-oauth-basic@github.com`n"
        Set-Content ".\.latest_version" "$env:TAG_NAME"
      }

  - if "%NEED_TO_PUBLISH%"=="True" (
      git config --global credential.helper store &&
      git config --global user.email "async3619@naver.com" &&
      git config --global user.name "Sophia" &&
      git tag -a %TAG_NAME% -m "%TAG_MESSAGE%" &&
      git push --tags &&
      git add . &&
      git checkout %BRANCH_NAME% &&
      git commit -m "update .latest_version [skip ci]" &&
      git push
    )

  - ps: |
      if ($env:NEED_TO_PUBLISH -and ("$env:APPVEYOR_REPO_TAG_NAME" -eq "")) {
        Exit-AppveyorBuild
      }

build_script:
  - cmd /c .\build.bat

  - set "PLATFORM=x64"
  - set "ARTIFACT_NAME=%BRANCH_NAME%-windows-%PLATFORM%-static"

  - 7z a -ttar %ARTIFACT_NAME%.tar ./boost/%BRANCH_NAME%-%PLATFORM%
  - 7z a -tgzip %ARTIFACT_NAME%.tar.gz %ARTIFACT_NAME%.tar

  - set "PLATFORM=x86"
  - set "ARTIFACT_NAME=%BRANCH_NAME%-windows-%PLATFORM%-static"

  - 7z a -ttar %ARTIFACT_NAME%.tar ./boost/%BRANCH_NAME%-%PLATFORM%
  - 7z a -tgzip %ARTIFACT_NAME%.tar.gz %ARTIFACT_NAME%.tar

  - ls

artifacts:
  - path: '.\*.tar.gz'

deploy:
  provider: GitHub
  auth_token:
    secure: HXeiYWOUHuaIgFjAduz+0mtu+TFeliN7kCR/Z3kGAine00S1puQ4xcKUk8L1IJVs
  artifact: /.*\.tar\.gz/
  force_update: true
  on:
    appveyor_repo_tag: true        # deploy on tag push only